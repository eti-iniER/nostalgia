name: Build and Deploy Backend and Frontend

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: src/frontend/package-lock.json

            - name: Install frontend dependencies
              run: |
                  cd src/frontend
                  npm ci

            - name: Build frontend
              env:
                  VITE_API_URL: /api/v1
              run: |
                  cd src/frontend
                  npm run build

            - name: Create frontend archive
              run: |
                  cd src/frontend
                  tar -czf ../frontend-build.tar.gz -C dist .

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to DockerHub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PERSONAL_ACCESS_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPOSITORY_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: ./src/backend
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Deploy frontend to server
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
                  source: "frontend-build.tar.gz"
                  target: "/tmp/"

            - name: Deploy backend and extract frontend
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
                  script: |
                      # Deploy backend
                      cd app
                      docker compose pull
                      docker compose up -d --force-recreate

                      # Deploy frontend
                      sudo mkdir -p /var/www/nostalgia
                      sudo rm -rf /var/www/nostalgia/*
                      cd /tmp
                      sudo tar -xzf frontend-build.tar.gz -C /var/www/nostalgia/
                      sudo chown -R www-data:www-data /var/www/nostalgia
                      rm -f frontend-build.tar.gz
